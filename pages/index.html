<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T9QK47XS');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HarmonyOS Installation Stats</title>
    <meta name="description" content="HarmonyOS installation statistics, growth charts, and forecasts. HarmonyOS安装统计、增长图表和预测。">
    <meta name="keywords" content="HarmonyOS, installation, statistics, stats, growth, forecast, 鸿蒙系统, 安装量, 统计, 增长, 预测">
    <meta name="author" content="HYwooo">
    <link rel="canonical" href="https://yourdomain.com/">
    <!-- Cache Control -->
    <meta http-equiv="Cache-Control" content="public, max-age=300">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- Font Awesome for language icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --background-color: #ffffff;
            --text-color: #000000;
            --accent-color: #007DFF;
            --overlay-background: rgba(255, 255, 255, 0.8);
            --container-background: rgba(255, 255, 255, 0.618);
            --container-border: rgba(128, 128, 128, 0.1);
            --chart-label-color: rgba(0, 0, 0, 0.7);
            --language-selector-bg: rgba(255, 255, 255, 0.8);
            --language-selector-border: rgba(128, 128, 128, 0.2);
            --language-selector-hover-bg: rgba(240, 240, 240, 0.9);
            --language-selector-text-color: rgba(0, 0, 0, 0.7); /* Default light mode text */
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #000000;
                --text-color: #ffffff;
                --accent-color: #007DFF;
                --overlay-background: rgba(0, 0, 0, 0.8);
                --container-background: rgba(30, 30, 30, 0.618);
                --container-border: rgba(255, 255, 255, 0.1);
                --chart-label-color: rgba(255, 255, 255, 0.7);
                --language-selector-bg: rgba(30, 30, 30, 0.8);
                --language-selector-border: rgba(255, 255, 255, 0.2);
                --language-selector-hover-bg: rgba(50, 50, 50, 0.9);
                --language-selector-text-color: rgba(255, 255, 255, 0.7); /* Dark mode text */
            }
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-background);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            margin-bottom: 20px;
        }
        .spinner-circle {
            fill: none;
            stroke: var(--accent-color); /* Use accent color for spinner */
            stroke-width: 4;
            stroke-linecap: round;
            transform-origin: center;
            animation: spinner-animation 1.5s ease-in-out infinite;
        }
        @keyframes spinner-animation {
            0% {
                stroke-dasharray: 1, 150;
                stroke-dashoffset: 0;
            }
            50% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -35;
            }
            100% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -124;
            }
        }
        .loading-text {
            font-size: 14px;
            font-weight: 400;
            letter-spacing: -0.2px;
            opacity: 0.7;
        }
        /* Main Content */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 40px 0 20px 0;
            position: relative; /* For language selector positioning */
        }
        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        h1::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            height: 3px;
            background-color: var(--accent-color);
        }
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.7;
            font-weight: 400;
        }
        .last-updated {
            font-size: 0.9rem;
            opacity: 0.6;
            margin-top: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0 40px 0;
        }
        .stat-card {
            background: var(--container-background);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px); /* Add blur effect */
            border: 1px solid var(--container-border);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--accent-color);
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            font-weight: 400;
        }
        .chart-container {
            background: var(--container-background);
            border-radius: 12px;
            padding: 25px;
            margin: 40px 0;
            backdrop-filter: blur(10px); /* Add blur effect */
            border: 1px solid var(--container-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .chart-label {
            font-size: 0.9rem;
            opacity: 0.7;
            font-weight: 400;
            text-align: center;
            margin-top: 15px;
            color: var(--chart-label-color);
        }
        #growth-chart {
            width: 100%;
            height: 400px;
        }
        #forecast-chart {
            width: 100%;
            height: 400px;
        }
        .milestone-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .milestone-card {
            background: var(--container-background);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px); /* Add blur effect */
            border: 1px solid var(--container-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        .milestone-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .milestone-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            margin: 5px 0;
        }
        .milestone-date {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .milestone-days {
            font-size: 0.9rem;
            font-weight: 600;
        }
        footer {
            text-align: center;
            padding: 40px 0;
            font-size: 0.9rem;
            opacity: 0.6;
        }
        footer a {
            color: var(--accent-color);
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }

        /* Language Selector */
        #language-selector {
            position: absolute;
            top: 10px; /* Upward offset by 10px */
            right: 20px;
            z-index: 100;
        }

        #language-toggle {
            background: var(--language-selector-bg);
            border: 1px solid var(--language-selector-border);
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 1rem;
            backdrop-filter: blur(10px); /* Add blur effect */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease, border-color 0.2s ease;
            color: var(--language-selector-text-color); /* Use chart label color for text */
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #language-toggle:hover {
            background: var(--language-selector-hover-bg);
        }

        #language-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--language-selector-bg);
            border: 1px solid var(--language-selector-border);
            border-radius: 8px;
            list-style: none;
            padding: 5px 0;
            margin-top: 5px;
            min-width: 120px;
            backdrop-filter: blur(15px); /* Add blur effect */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #language-options.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        #language-options li {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--language-selector-text-color); /* Use chart label color for text */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #language-options li:hover {
            background: var(--language-selector-hover-bg);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 2rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .stat-card {
                padding: 20px;
            }
            .stat-value {
                font-size: 1.8rem;
            }
            #growth-chart, #forecast-chart {
                height: 300px;
            }
            #language-selector {
                top: 5px; /* Adjust for smaller screens */
                right: 15px;
            }
            #language-toggle {
                padding: 6px 12px;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 480px) {
            header {
                padding: 30px 0 15px 0;
            }
            h1 {
                font-size: 1.7rem;
            }
            .subtitle {
                font-size: 0.9rem;
            }
            .stat-value {
                font-size: 1.5rem;
            }
            #language-selector {
                top: 0px; /* Adjust for smaller screens */
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T9QK47XS"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <svg class="loading-spinner" viewBox="0 0 50 50">
            <circle class="spinner-circle" cx="25" cy="25" r="20"></circle>
        </svg>
        <div class="loading-text" data-i18n="loading_text">Loading HarmonyOS Installation Stats</div>
    </div>
    <!-- Main Content -->
    <div class="container">
        <header>
            <div id="language-selector">
                <button id="language-toggle" aria-haspopup="true" aria-expanded="false">
                    <i class="fas fa-language"></i> <span id="language-text">EN</span>
                </button>
                <ul id="language-options" role="menu">
                    <li role="menuitem" data-lang="en">English</li>
                    <li role="menuitem" data-lang="zh-CN">中文</li>
                </ul>
            </div>
            <h1 data-i18n="page_title">HarmonyOS Installation Stats</h1>
            <p class="subtitle" data-i18n="page_subtitle">HarmonyOS Installation Statistics and Growth Forecast</p>
            <p class="last-updated" id="last-updated" data-i18n="last_updated">Latest Updated: --</p>
        </header>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-installations">--</div>
                <div class="stat-label" data-i18n="total_installations_label">Total Installations</div>
            </div>
        </div>
        <div class="chart-container">
            <div id="growth-chart"></div>
            <div class="chart-label" data-i18n="growth_chart_label">HarmonyOS Installation Growth Chart</div>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-increase">--</div>
                <div class="stat-label" data-i18n="total_increase_label">14-Day Total Installation Increase</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-daily-increase">--</div>
                <div class="stat-label" data-i18n="avg_daily_increase_label">14-Day Average Daily Installation Increase</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-growth-rate">--</div>
                <div class="stat-label" data-i18n="avg_growth_rate_label">14-Day Average Daily Installation Growth Rate</div>
            </div>
        </div>
        <div class="chart-container">
            <div id="forecast-chart"></div>
            <div class="chart-label" data-i18n="forecast_chart_label">Forecast Timeline to Reach Milestone</div>
        </div>
        <div class="milestone-grid">
            <div class="milestone-card">
                <div class="milestone-title" data-i18n="milestone_1_title">Milestone 1</div>
                <div class="milestone-value" id="milestone-1b">--</div>
                <div class="milestone-date" id="date-1b" data-i18n="target_date">Target Date: --</div>
                <div class="milestone-days" id="days-1b" data-i18n="days_remaining">Days Remaining: --</div>
            </div>
            <div class="milestone-card">
                <div class="milestone-title" data-i18n="milestone_2_title">Milestone 2</div>
                <div class="milestone-value" id="milestone-2b">--</div>
                <div class="milestone-date" id="date-2b" data-i18n="target_date">Target Date: --</div>
                <div class="milestone-days" id="days-2b" data-i18n="days_remaining">Days Remaining: --</div>
            </div>
            <div class="milestone-card">
                <div class="milestone-title" data-i18n="milestone_3_title">Milestone 3</div>
                <div class="milestone-value" id="milestone-5b">--</div>
                <div class="milestone-date" id="date-5b" data-i18n="target_date">Target Date: --</div>
                <div class="milestone-days" id="days-5b" data-i18n="days_remaining">Days Remaining: --</div>
            </div>
        </div>
        <footer>
            <p>© 2025 <a href="https://github.com/HYwooo/harmonyos-installation-stats/" target="_blank">HYwooo</a>. Raw data are acquired from harmony5.cn.</p>
        </footer>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- i18n ---
            const translations = {
                en: {
                    loading_text: "Loading HarmonyOS Installation Stats",
                    page_title: "HarmonyOS Installation Stats",
                    page_subtitle: "HarmonyOS Installation Statistics and Growth Forecast",
                    last_updated: "Latest Updated: ",
                    total_installations_label: "Total Installations",
                    growth_chart_label: "HarmonyOS Installation Growth Chart",
                    total_increase_label: "14-Day Total Installation Increase",
                    avg_daily_increase_label: "14-Day Average Daily Installation Increase",
                    avg_growth_rate_label: "14-Day Average Daily Installation Growth Rate",
                    forecast_chart_label: "Forecast Timeline to Reach Milestone",
                    milestone_1_title: "Milestone 1",
                    milestone_2_title: "Milestone 2",
                    milestone_3_title: "Milestone 3",
                    target_date: "Target Date: ",
                    days_remaining: "Days Remaining: "
                },
                'zh-CN': {
                    loading_text: "正在加载 HarmonyOS 安装统计",
                    page_title: "HarmonyOS 安装统计",
                    page_subtitle: "HarmonyOS 安装统计数据与增长预测",
                    last_updated: "最近更新于: ",
                    total_installations_label: "总安装量",
                    growth_chart_label: "HarmonyOS 安装量增长图表",
                    total_increase_label: "14天总安装量增长",
                    avg_daily_increase_label: "14天平均每日安装量增长",
                    avg_growth_rate_label: "14天平均每日安装量增长率",
                    forecast_chart_label: "达到里程碑的预测时间线",
                    milestone_1_title: "里程碑 1",
                    milestone_2_title: "里程碑 2",
                    milestone_3_title: "里程碑 3",
                    target_date: "预计日期: ",
                    days_remaining: "剩余天数: "
                }
            };

            let currentLang = 'en'; // Default fallback
            let globalData = null; // Store data globally to access after language change

            // Detect browser language
            const userLang = navigator.language || navigator.userLanguage;
            if (userLang.startsWith('zh')) {
                currentLang = 'zh-CN';
            } else {
                currentLang = 'en';
            }

            // Language switcher logic
            const toggleButton = document.getElementById('language-toggle');
            const languageText = document.getElementById('language-text');
            const optionsList = document.getElementById('language-options');

            toggleButton.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                this.setAttribute('aria-expanded', !isExpanded);
                optionsList.classList.toggle('show');
            });

            document.querySelectorAll('#language-options li').forEach(item => {
                item.addEventListener('click', function() {
                    const selectedLang = this.getAttribute('data-lang');
                    if (selectedLang && selectedLang !== currentLang) {
                        currentLang = selectedLang;
                        translatePage();
                        // Reload all content that depends on language
                        if (globalData) {
                            calculateStats(globalData); // This will update last-updated and milestones
                            // Also recalculate and redraw forecast if needed
                            forecastData = calculateForecast(globalData);
                            if (forecastData) {
                                createForecastChart(globalData, forecastData);
                            }
                        }
                        // Update button text
                        languageText.textContent = currentLang === 'en' ? 'EN' : '中文';
                    }
                    optionsList.classList.remove('show');
                    toggleButton.setAttribute('aria-expanded', 'false');
                });
            });

            // Close language selector if clicked outside
            document.addEventListener('click', function(event) {
                if (!toggleButton.contains(event.target) && !optionsList.contains(event.target)) {
                    optionsList.classList.remove('show');
                    toggleButton.setAttribute('aria-expanded', 'false');
                }
            });

            function translatePage() {
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (translations[currentLang] && translations[currentLang][key]) {
                        element.textContent = translations[currentLang][key];
                    }
                });
                // Update the loading text specifically if it's still visible
                const loadingText = document.querySelector('.loading-text');
                if (loadingText) {
                    loadingText.textContent = translations[currentLang]['loading_text'];
                }
                // Update the HTML lang attribute
                document.documentElement.lang = currentLang;
            }

            // Set initial button text
            languageText.textContent = currentLang === 'en' ? 'EN' : '中文';
            // Apply initial translation
            translatePage();

            // --- Chart and Data Logic ---
            let chartData = null;
            let forecastData = null;

            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',');
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index].trim();
                    });
                    data.push(row);
                }
                return data;
            }

            function formatNumber(num) {
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            }

            function getNextMilestones(current) {
                const currentB = current / 1000000000;
                const scale = Math.pow(10, Math.floor(Math.log10(currentB)));
                const firstDigit = Math.floor(currentB / scale);
                let milestone1, milestone2, milestone5;
                if (firstDigit < 1) {
                    milestone1 = 1 * scale * 1000000000;
                    milestone2 = 2 * scale * 1000000000;
                    milestone5 = 5 * scale * 1000000000;
                } else if (firstDigit === 1) {
                    milestone1 = 2 * scale * 1000000000;
                    milestone2 = 5 * scale * 1000000000;
                    milestone5 = 10 * scale * 1000000000;
                } else if (firstDigit < 5) {
                    milestone1 = 5 * scale * 1000000000;
                    milestone2 = 10 * scale * 1000000000;
                    milestone5 = 20 * scale * 1000000000;
                } else {
                    milestone1 = 10 * scale * 1000000000;
                    milestone2 = 20 * scale * 1000000000;
                    milestone5 = 50 * scale * 1000000000;
                }
                return [milestone1, milestone2, milestone5];
            }

            // --- Modified Forecast Calculation Logic ---
            function calculateForecast(data) {
                if (data.length === 0) return null;
                const latest = data[data.length - 1];
                const currentInstallations = parseInt(latest.Installations);
                const currentDate = new Date(latest.Date);
                const [milestone1, milestone2, milestone5] = getNextMilestones(currentInstallations);
                const targetMilestone = milestone2;
                const startDateIndex = Math.max(0, data.length - 14);
                const periodData = data.slice(startDateIndex);
                if (periodData.length < 2) return null;

                const growthRates = [];
                const dailyIncreases = [];
                for (let i = 1; i < periodData.length; i++) {
                    const rate = parseFloat(periodData[i].Growth_Rate);
                    const dailyInc = parseInt(periodData[i].Daily_Increase);
                    if (!isNaN(rate)) growthRates.push(Math.abs(rate));
                    if (!isNaN(dailyInc)) dailyIncreases.push(dailyInc);
                }
                if (growthRates.length === 0 || dailyIncreases.length === 0) return null;

                // Calculate average growth metrics
                const avgGrowthRate = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;
                const avgDailyIncrease = dailyIncreases.reduce((a, b) => a + b, 0) / dailyIncreases.length;

                // Sort growth rates for optimistic/pessimistic calculations
                growthRates.sort((a, b) => a - b);
                const optimisticIndex = Math.ceil(growthRates.length * 0.5);
                const optimisticRates = growthRates.slice(optimisticIndex);
                const optimisticGrowthRate = optimisticRates.length > 0 ?
                    optimisticRates.reduce((a, b) => a + b, 0) / optimisticRates.length : avgGrowthRate;
                const pessimisticRates = growthRates.slice(0, optimisticIndex);
                const pessimisticGrowthRate = pessimisticRates.length > 0 ?
                    pessimisticRates.reduce((a, b) => a + b, 0) / pessimisticRates.length : avgGrowthRate;

                // First, calculate days using constant growth rate model
                const daysToTargetGrowthRate = Math.ceil(Math.log(targetMilestone / currentInstallations) / Math.log(1 + avgGrowthRate/100));

                // Determine which model to use based on days remaining
                const USE_LINEAR_MODEL_THRESHOLD = 30;
                const useLinearModel = daysToTargetGrowthRate > USE_LINEAR_MODEL_THRESHOLD;

                if (useLinearModel) {
                    // Use constant daily increase model
                    // Convert growth rates to daily increases for optimistic/pessimistic
                    const currentDailyIncrease = avgDailyIncrease;
                    const optimisticDailyIncrease = (optimisticGrowthRate / 100) * currentInstallations;
                    const pessimisticDailyIncrease = (pessimisticGrowthRate / 100) * currentInstallations;
                    
                    // Calculate days using linear model
                    const daysToTargetMostLikely = Math.ceil((targetMilestone - currentInstallations) / currentDailyIncrease);
                    const daysToTargetOptimistic = Math.ceil((targetMilestone - currentInstallations) / optimisticDailyIncrease);
                    const daysToTargetPessimistic = Math.ceil((targetMilestone - currentInstallations) / pessimisticDailyIncrease);
                    
                    // Calculate dates
                    const dateMostLikely = new Date(currentDate);
                    dateMostLikely.setDate(dateMostLikely.getDate() + Math.max(0, daysToTargetMostLikely));
                    const dateOptimistic = new Date(currentDate);
                    dateOptimistic.setDate(dateOptimistic.getDate() + Math.max(0, daysToTargetOptimistic));
                    const datePessimistic = new Date(currentDate);
                    datePessimistic.setDate(datePessimistic.getDate() + Math.max(0, daysToTargetPessimistic));

                    return {
                        currentInstallations,
                        currentDate,
                        targetMilestone,
                        avgDailyIncrease: currentDailyIncrease,
                        optimisticDailyIncrease,
                        pessimisticDailyIncrease,
                        useLinearModel: true,
                        daysToTargetMostLikely,
                        daysToTargetOptimistic,
                        daysToTargetPessimistic,
                        dateMostLikely,
                        dateOptimistic,
                        datePessimistic
                    };
                } else {
                    // Use constant growth rate model (original logic)
                    const daysToTargetMostLikely = daysToTargetGrowthRate;
                    const daysToTargetOptimistic = Math.ceil(Math.log(targetMilestone / currentInstallations) / Math.log(1 + optimisticGrowthRate/100));
                    const daysToTargetPessimistic = Math.ceil(Math.log(targetMilestone / currentInstallations) / Math.log(1 + pessimisticGrowthRate/100));

                    const dateMostLikely = new Date(currentDate);
                    dateMostLikely.setDate(dateMostLikely.getDate() + Math.max(0, daysToTargetMostLikely));
                    const dateOptimistic = new Date(currentDate);
                    dateOptimistic.setDate(dateOptimistic.getDate() + Math.max(0, daysToTargetOptimistic));
                    const datePessimistic = new Date(currentDate);
                    datePessimistic.setDate(datePessimistic.getDate() + Math.max(0, daysToTargetPessimistic));

                    return {
                        currentInstallations,
                        currentDate,
                        targetMilestone,
                        avgGrowthRate,
                        optimisticGrowthRate,
                        pessimisticGrowthRate,
                        useLinearModel: false,
                        daysToTargetMostLikely,
                        daysToTargetOptimistic,
                        daysToTargetPessimistic,
                        dateMostLikely,
                        dateOptimistic,
                        datePessimistic
                    };
                }
            }

            function createForecastChart(data, forecastData) {
                if (!forecastData) {
                    document.getElementById('forecast-chart').innerHTML =
                        `<div style="height: 300px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; opacity: 0.7;" data-i18n="chart_load_failed">${translations[currentLang]['chart_load_failed'] || 'Failed to calculate forecast'}</div>`;
                    return;
                }

                const dates = data.map(row => row.Date);
                const installations = data.map(row => parseInt(row.Installations.replace(/,/g, '')));

                // Get chart label color for axis fonts
                const chartLabelColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-label-color').trim();

                const historicalTrace = {
                    x: dates,
                    y: installations,
                    mode: 'lines+markers',
                    line: { shape: 'spline', color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() },
                    marker: { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() },
                    name: translations[currentLang]['historical_data'] || 'Historical Data',
                    showlegend: false
                };

                // Determine which model was used for forecast
                if (forecastData.useLinearModel) {
                    // Linear model forecast line
                    const forecastDates = [forecastData.currentDate.toISOString().split('T')[0], forecastData.dateMostLikely.toISOString().split('T')[0]];
                    const forecastInstallations = [forecastData.currentInstallations, forecastData.targetMilestone];
                    
                    const linearForecastTrace = {
                        x: forecastDates,
                        y: forecastInstallations,
                        mode: 'lines+markers',
                        line: { dash: 'dot', color: '#0a84ff' },
                        marker: { color: '#0a84ff' },
                        name: translations[currentLang]['linear_forecast'] || 'Linear Forecast',
                        showlegend: false
                    };

                    const annotations = [
                        {
                            x: forecastData.dateMostLikely.toISOString().split('T')[0],
                            y: forecastData.targetMilestone,
                            xref: 'x',
                            yref: 'y',
                            text: `${forecastData.dateMostLikely.toISOString().split('T')[0]}<br>${translations[currentLang]['linear_forecast_label'] || 'Linear Forecast'}`,
                            showarrow: true,
                            arrowhead: 7,
                            ax: 0,
                            ay: -40,
                            bgcolor: 'rgba(255, 255, 255, 0.8)',
                            bordercolor: '#0a84ff',
                            borderwidth: 2,
                            font: { color: '#0a84ff', size: 12 }
                        }
                    ];

                    const layout = {
                        margin: { t: 0, b: 40, l: 50, r: 50 },
                        xaxis: {
                            title: translations[currentLang]['date_label'] || 'Date',
                            color: chartLabelColor, // Use chart label color
                            titlefont: { color: chartLabelColor }, // Set title font color
                            tickfont: { color: chartLabelColor }  // Set tick font color
                        },
                        yaxis: {
                            title: translations[currentLang]['installations_label'] || 'Installations',
                            color: chartLabelColor, // Use chart label color
                            titlefont: { color: chartLabelColor }, // Set title font color
                            tickfont: { color: chartLabelColor }  // Set tick font color
                        },
                        template: 'plotly_white',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        showlegend: false,
                        annotations: annotations
                    };

                    Plotly.newPlot('forecast-chart', [historicalTrace, linearForecastTrace], layout, {responsive: true});
                } else {
                    // Exponential model forecast lines (original logic)
                    const forecastDates = [forecastData.currentDate.toISOString().split('T')[0], forecastData.dateOptimistic.toISOString().split('T')[0]];
                    const forecastInstallations = [forecastData.currentInstallations, forecastData.targetMilestone];
                    const optimisticTrace = {
                        x: forecastDates,
                        y: forecastInstallations,
                        mode: 'lines+markers',
                        line: { dash: 'dot', color: '#32d74b' },
                        marker: { color: '#32d74b' },
                        name: translations[currentLang]['optimistic_forecast'] || 'Optimistic Forecast',
                        showlegend: false
                    };

                    const forecastDates2 = [forecastData.currentDate.toISOString().split('T')[0], forecastData.dateMostLikely.toISOString().split('T')[0]];
                    const mostLikelyTrace = {
                        x: forecastDates2,
                        y: forecastInstallations,
                        mode: 'lines+markers',
                        line: { dash: 'dot', color: '#0a84ff' },
                        marker: { color: '#0a84ff' },
                        name: translations[currentLang]['likely_forecast'] || 'Most Likely Forecast',
                        showlegend: false
                    };

                    const forecastDates3 = [forecastData.currentDate.toISOString().split('T')[0], forecastData.datePessimistic.toISOString().split('T')[0]];
                    const pessimisticTrace = {
                        x: forecastDates3,
                        y: forecastInstallations,
                        mode: 'lines+markers',
                        line: { dash: 'dot', color: '#ff9f0a' },
                        marker: { color: '#ff9f0a' },
                        name: translations[currentLang]['pessimistic_forecast'] || 'Pessimistic Forecast',
                        showlegend: false
                    };

                    const annotations = window.innerWidth > 768 ? [
                        {
                            x: forecastData.dateOptimistic.toISOString().split('T')[0],
                            y: forecastData.targetMilestone,
                            xref: 'x',
                            yref: 'y',
                            text: `${translations[currentLang]['optimistic_label'] || 'Optimistic'}<br>${forecastData.dateOptimistic.toISOString().split('T')[0]}`,
                            showarrow: true,
                            arrowhead: 7,
                            ax: 0,
                            ay: -40,
                            bgcolor: 'rgba(50, 215, 75, 0.1)',
                            bordercolor: '#32d74b',
                            font: { color: '#32d74b' }
                        },
                        {
                            x: forecastData.dateMostLikely.toISOString().split('T')[0],
                            y: forecastData.targetMilestone,
                            xref: 'x',
                            yref: 'y',
                            text: `${translations[currentLang]['likely_label'] || 'Most Likely'}<br>${forecastData.dateMostLikely.toISOString().split('T')[0]}`,
                            showarrow: true,
                            arrowhead: 7,
                            ax: 0,
                            ay: -40,
                            bgcolor: 'rgba(10, 132, 255, 0.1)',
                            bordercolor: '#0a84ff',
                            font: { color: '#0a84ff' }
                        },
                        {
                            x: forecastData.datePessimistic.toISOString().split('T')[0],
                            y: forecastData.targetMilestone,
                            xref: 'x',
                            yref: 'y',
                            text: `${translations[currentLang]['pessimistic_label'] || 'Pessimistic'}<br>${forecastData.datePessimistic.toISOString().split('T')[0]}`,
                            showarrow: true,
                            arrowhead: 7,
                            ax: 0,
                            ay: -40,
                            bgcolor: 'rgba(255, 159, 10, 0.1)',
                            bordercolor: '#ff9f0a',
                            font: { color: '#ff9f0a' }
                        }
                    ] : [];

                    const middlePointAnnotation = {
                        x: forecastData.dateMostLikely.toISOString().split('T')[0],
                        y: forecastData.targetMilestone,
                        xref: 'x',
                        yref: 'y',
                        text: `${forecastData.dateMostLikely.toISOString().split('T')[0]}<br>${translations[currentLang]['likely_approx'] || 'Most Likely Approx.'}`,
                        showarrow: true,
                        arrowhead: 7,
                        ax: 0,
                        ay: -40,
                        bgcolor: 'rgba(255, 255, 255, 0.8)',
                        bordercolor: '#0a84ff',
                        borderwidth: 2,
                        font: { color: '#0a84ff', size: 12 }
                    };
                    annotations.push(middlePointAnnotation);

                    const layout = {
                        margin: { t: 0, b: 40, l: 50, r: 50 },
                        xaxis: {
                            title: translations[currentLang]['date_label'] || 'Date',
                            color: chartLabelColor, // Use chart label color
                            titlefont: { color: chartLabelColor }, // Set title font color
                            tickfont: { color: chartLabelColor }  // Set tick font color
                        },
                        yaxis: {
                            title: translations[currentLang]['installations_label'] || 'Installations',
                            color: chartLabelColor, // Use chart label color
                            titlefont: { color: chartLabelColor }, // Set title font color
                            tickfont: { color: chartLabelColor }  // Set tick font color
                        },
                        template: 'plotly_white',
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        showlegend: false,
                        annotations: annotations
                    };

                    Plotly.newPlot('forecast-chart', [historicalTrace, optimisticTrace, mostLikelyTrace, pessimisticTrace], layout, {responsive: true});
                }
            }

            function calculateMilestones(data) {
                if (data.length === 0) return;
                const latest = data[data.length - 1];
                const currentInstallations = parseInt(latest.Installations);
                const [milestone1, milestone2, milestone5] = getNextMilestones(currentInstallations);
                document.getElementById('milestone-1b').textContent = formatNumber(milestone1);
                document.getElementById('milestone-2b').textContent = formatNumber(milestone2);
                document.getElementById('milestone-5b').textContent = formatNumber(milestone5);

                const startDateIndex = Math.max(0, data.length - 14);
                const periodData = data.slice(startDateIndex);
                if (periodData.length < 2) {
                    document.getElementById('date-1b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}--`;
                    document.getElementById('date-2b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}--`;
                    document.getElementById('date-5b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}--`;
                    document.getElementById('days-1b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}--`;
                    document.getElementById('days-2b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}--`;
                    document.getElementById('days-5b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}--`;
                    return;
                }

                const growthRates = [];
                const dailyIncreases = [];
                for (let i = 1; i < periodData.length; i++) {
                    const rate = Math.abs(parseFloat(periodData[i].Growth_Rate));
                    const dailyInc = parseInt(periodData[i].Daily_Increase);
                    if (!isNaN(rate) && rate > 0) growthRates.push(rate);
                    if (!isNaN(dailyInc)) dailyIncreases.push(dailyInc);
                }
                if (growthRates.length === 0 || dailyIncreases.length === 0) {
                    document.getElementById('date-1b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}--`;
                    document.getElementById('date-2b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}--`;
                    document.getElementById('date-5b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}--`;
                    document.getElementById('days-1b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}--`;
                    document.getElementById('days-2b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}--`;
                    document.getElementById('days-5b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}--`;
                    return;
                }

                // Calculate average growth metrics
                const avgGrowthRate = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;
                const avgDailyIncrease = dailyIncreases.reduce((a, b) => a + b, 0) / dailyIncreases.length;

                // Sort growth rates for optimistic/pessimistic calculations
                growthRates.sort((a, b) => a - b);
                const optimisticIndex = Math.ceil(growthRates.length * 0.5);
                const optimisticRates = growthRates.slice(optimisticIndex);
                const optimisticGrowthRate = optimisticRates.length > 0 ?
                    optimisticRates.reduce((a, b) => a + b, 0) / optimisticRates.length : avgGrowthRate;
                const pessimisticRates = growthRates.slice(0, optimisticIndex);
                const pessimisticGrowthRate = pessimisticRates.length > 0 ?
                    pessimisticRates.reduce((a, b) => a + b, 0) / pessimisticRates.length : avgGrowthRate;

                // First, calculate days using constant growth rate model for milestone 2
                const daysTo2GrowthRate = Math.ceil(Math.log(milestone2 / currentInstallations) / Math.log(1 + avgGrowthRate/100));

                // Determine which model to use based on days remaining for milestone 2
                const USE_LINEAR_MODEL_THRESHOLD = 30;
                const useLinearModel = daysTo2GrowthRate > USE_LINEAR_MODEL_THRESHOLD;

                let daysTo1, daysTo2, daysTo5;
                if (useLinearModel) {
                    // Use constant daily increase model
                    const currentDailyIncrease = avgDailyIncrease;
                    const optimisticDailyIncrease = (optimisticGrowthRate / 100) * currentInstallations;
                    const pessimisticDailyIncrease = (pessimisticGrowthRate / 100) * currentInstallations;
                    
                    // Calculate days using linear model for all milestones
                    daysTo1 = Math.ceil((milestone1 - currentInstallations) / currentDailyIncrease);
                    daysTo2 = Math.ceil((milestone2 - currentInstallations) / currentDailyIncrease);
                    daysTo5 = Math.ceil((milestone5 - currentInstallations) / currentDailyIncrease);
                } else {
                    // Use constant growth rate model (original calculations)
                    const growthRate = Math.abs(avgGrowthRate) / 100;
                    daysTo1 = Math.ceil(Math.log(milestone1 / currentInstallations) / Math.log(1 + growthRate));
                    daysTo2 = Math.ceil(Math.log(milestone2 / currentInstallations) / Math.log(1 + growthRate));
                    daysTo5 = Math.ceil(Math.log(milestone5 / currentInstallations) / Math.log(1 + growthRate));
                }

                const currentDate = new Date(latest.Date);
                const date1 = new Date(currentDate);
                date1.setDate(date1.getDate() + Math.max(0, daysTo1));
                const date2 = new Date(currentDate);
                date2.setDate(date2.getDate() + Math.max(0, daysTo2));
                const date5 = new Date(currentDate);
                date5.setDate(date5.getDate() + Math.max(0, daysTo5));

                const formatDate = (date) => date.toISOString().split('T')[0];

                document.getElementById('date-1b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}${daysTo1 >= 0 ? formatDate(date1) : '--'}`;
                document.getElementById('date-2b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}${daysTo2 >= 0 ? formatDate(date2) : '--'}`;
                document.getElementById('date-5b').textContent = `${translations[currentLang]['target_date'] || 'Target Date: '}${daysTo5 >= 0 ? formatDate(date5) : '--'}`;
                document.getElementById('days-1b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}${daysTo1 >= 0 ? daysTo1 : '--'}`;
                document.getElementById('days-2b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}${daysTo2 >= 0 ? daysTo2 : '--'}`;
                document.getElementById('days-5b').textContent = `${translations[currentLang]['days_remaining'] || 'Days Remaining: '}${daysTo5 >= 0 ? daysTo5 : '--'}`;
            }

            function calculateStats(data) {
                if (data.length === 0) return null;
                const latest = data[data.length - 1];
                // Update last updated date with translation
                document.getElementById('last-updated').textContent = `${translations[currentLang]['last_updated'] || 'Latest Updated: '}${latest.Date}`;
                document.getElementById('total-installations').textContent = formatNumber(parseInt(latest.Installations));

                const startDateIndex = Math.max(0, data.length - 14);
                const periodData = data.slice(startDateIndex);
                if (periodData.length < 2) {
                    document.getElementById('total-increase').textContent = '--';
                    document.getElementById('avg-daily-increase').textContent = '--';
                    document.getElementById('avg-growth-rate').textContent = '--';
                    return;
                }

                const startValue = parseInt(periodData[0].Installations);
                const endValue = parseInt(periodData[periodData.length - 1].Installations);
                const totalIncrease = endValue - startValue;
                document.getElementById('total-increase').textContent = formatNumber(totalIncrease);

                const dailyIncreases = [];
                for (let i = 1; i < periodData.length; i++) {
                    dailyIncreases.push(parseInt(periodData[i].Daily_Increase));
                }
                const avgDailyIncrease = dailyIncreases.reduce((a, b) => a + b, 0) / dailyIncreases.length;
                document.getElementById('avg-daily-increase').textContent = formatNumber(Math.round(avgDailyIncrease));

                const growthRates = [];
                for (let i = 1; i < periodData.length; i++) {
                    const rate = parseFloat(periodData[i].Growth_Rate);
                    if (!isNaN(rate)) growthRates.push(rate);
                }
                const avgGrowthRate = growthRates.reduce((a, b) => a + b, 0) / growthRates.length;
                document.getElementById('avg-growth-rate').textContent = avgGrowthRate.toFixed(1) + '%';

                calculateMilestones(data);
                forecastData = calculateForecast(data);
                createForecastChart(data, forecastData);
            }

            function createGrowthChart(data) {
                chartData = data;
                const dates = data.map(row => row.Date);
                const installations = data.map(row => parseInt(row.Installations.replace(/,/g, '')));

                // Get chart label color for axis fonts
                const chartLabelColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-label-color').trim();

                const trace = {
                    x: dates,
                    y: installations,
                    mode: 'lines+markers',
                    line: { shape: 'spline', color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() },
                    marker: { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim() },
                    name: translations[currentLang]['installations_label'] || 'Installations',
                    showlegend: false
                };

                const latest = data[data.length - 1];
                const lastPointAnnotation = {
                    x: latest.Date,
                    y: parseInt(latest.Installations),
                    xref: 'x',
                    yref: 'y',
                    text: `${formatNumber(parseInt(latest.Installations))}<br>${latest.Date}`,
                    showarrow: true,
                    arrowhead: 7,
                    ax: 0,
                    ay: -40,
                    bgcolor: 'rgba(255, 255, 255, 0.8)',
                    bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim(),
                    borderwidth: 2,
                    font: { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim(), size: 12 }
                };

                const layout = {
                    margin: { t: 0, b: 40, l: 50, r: 50 },
                    xaxis: {
                        title: translations[currentLang]['date_label'] || 'Date',
                        color: chartLabelColor, // Use chart label color
                        titlefont: { color: chartLabelColor }, // Set title font color
                        tickfont: { color: chartLabelColor }  // Set tick font color
                    },
                    yaxis: {
                        title: translations[currentLang]['installations_label'] || 'Installations',
                        color: chartLabelColor, // Use chart label color
                        titlefont: { color: chartLabelColor }, // Set title font color
                        tickfont: { color: chartLabelColor }  // Set tick font color
                    },
                    template: 'plotly_white',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    showlegend: false,
                    annotations: [lastPointAnnotation]
                };

                Plotly.newPlot('growth-chart', [trace], layout, {responsive: true});
            }

            function resizeChart() {
                if (chartData) {
                    const chartLabelColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-label-color').trim();
                    
                    // Update growth chart axis colors
                    Plotly.relayout('growth-chart', {
                        'xaxis.color': chartLabelColor,
                        'xaxis.titlefont.color': chartLabelColor,
                        'xaxis.tickfont.color': chartLabelColor,
                        'yaxis.color': chartLabelColor,
                        'yaxis.titlefont.color': chartLabelColor,
                        'yaxis.tickfont.color': chartLabelColor
                    });
                    
                    if (forecastData) {
                        // Update forecast chart axis colors
                        Plotly.relayout('forecast-chart', {
                            'xaxis.color': chartLabelColor,
                            'xaxis.titlefont.color': chartLabelColor,
                            'xaxis.tickfont.color': chartLabelColor,
                            'yaxis.color': chartLabelColor,
                            'yaxis.titlefont.color': chartLabelColor,
                            'yaxis.tickfont.color': chartLabelColor
                        });
                        
                        // Redraw forecast chart on resize to handle responsive annotations
                        createForecastChart(chartData, forecastData);
                    }
                    Plotly.Plots.resize('growth-chart');
                    Plotly.Plots.resize('forecast-chart');
                }
            }

            // Function to get current date in YYYYMMDD format
            function getCurrentDateYYYYMMDD() {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            }

            // Load CSV data with cache-busting query parameter
            const csvUrl = `https://fastly.jsdelivr.net/gh/HYwooo/harmonyos-installation-stats@master/harmony_install_stats.csv?v=${getCurrentDateYYYYMMDD()}`;
            
            //const csvUrl = `https://fastly.jsdelivr.net/gh/HYwooo/harmonyos-installation-stats@master/harmony_install_stats.csv`;
            fetch(csvUrl)
                .then(response => response.text())
                .then(csvText => {
                    const data = parseCSV(csvText);
                    globalData = data; // Store data globally
                    createGrowthChart(data);
                    calculateStats(data);
                })
                .catch(error => {
                    console.error('Error loading CSV ', error);
                    document.getElementById('growth-chart').innerHTML = `<div style="height: 300px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; opacity: 0.7;" data-i18n="chart_load_failed">${translations[currentLang]['chart_load_failed'] || 'Failed to load chart data'}</div>`;
                });

            // Hide loading overlay
            function hideLoadingOverlay() {
                const overlay = document.getElementById('loading-overlay');
                anime({
                    targets: overlay,
                    opacity: 0,
                    duration: 800,
                    easing: 'easeOutQuad',
                    complete: function() {
                        overlay.style.visibility = 'hidden';
                        overlay.style.display = 'none';
                    }
                });
            }

            setTimeout(function() {
                hideLoadingOverlay();
            }, 2000);

            // Animate loading spinner
            const spinner = document.querySelector('.spinner-circle');
            anime({
                targets: spinner,
                rotate: '1turn',
                duration: 2000,
                easing: 'linear',
                loop: true
            });

            // Animate loading text
            const loadingText = document.querySelector('.loading-text');
            anime({
                targets: loadingText,
                opacity: [0.7, 1, 0.7],
                duration: 2000,
                easing: 'easeInOutSine',
                loop: true
            });

            // Handle window resize
            window.addEventListener('resize', resizeChart);
        });
    </script>
</body>
</html>
